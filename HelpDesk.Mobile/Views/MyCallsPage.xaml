<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="HelpDesk.Mobile.Views.MyCallsPage"
             xmlns:vm="clr-namespace:HelpDesk.Mobile.ViewModels"
             xmlns:dto="clr-namespace:SuporteTI.Shared.Models.Dto;assembly=SuporteTI.Shared"
             Title="Meus Chamados"
             BackgroundColor="#f4f6fb">

    <!-- Grid principal: Linha Auto para o topo, Linha * (restante) para a lista -->
    <Grid RowDefinitions="Auto, *">

        <!-- Cabeçalho -->
        <StackLayout Grid.Row="0" Padding="20" BackgroundColor="#2563eb">
            <Label Text="Histórico de Chamados" FontSize="22" FontAttributes="Bold" TextColor="White" HorizontalOptions="Center"/>
            <Label Text="Acompanhe suas solicitações" FontSize="14" TextColor="#e0e7ff" HorizontalOptions="Center"/>
        </StackLayout>

        <!-- Lista com Pull-to-Refresh -->
        <RefreshView Grid.Row="1" 
                     Command="{Binding CarregarChamadosCommand}"
                     IsRefreshing="{Binding IsRefreshing}"
                     RefreshColor="#2563eb">

            <CollectionView ItemsSource="{Binding MeusChamados}" 
                            SelectionMode="None"
                            Margin="10">

                <!-- O que mostrar se a lista estiver vazia -->
                <CollectionView.EmptyView>
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center" Spacing="10" Padding="20">
                        <Label Text="📭" FontSize="40" HorizontalOptions="Center" TextColor="Gray"/>
                        <Label Text="Nenhum chamado encontrado." TextColor="Gray" HorizontalOptions="Center"/>
                        <Button Text="Atualizar" Command="{Binding CarregarChamadosCommand}" BackgroundColor="#2563eb" TextColor="White" HeightRequest="40"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>

                <!-- Template de cada chamado (Card) -->
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="dto:TicketListDto">
                        <Frame Margin="0,5" Padding="15" CornerRadius="10" HasShadow="True" BorderColor="Transparent" BackgroundColor="White">
                            <Grid ColumnDefinitions="*, Auto">
                                <VerticalStackLayout Grid.Column="0" Spacing="2">
                                    <Label Text="{Binding Titulo}" FontAttributes="Bold" FontSize="16" TextColor="#1e293b" LineBreakMode="TailTruncation"/>
                                    <Label Text="{Binding NomeSolicitante}" FontSize="12" TextColor="Gray"/>
                                    <Label Text="{Binding DataAbertura, StringFormat='{0:dd/MM/yyyy HH:mm}'}" FontSize="11" TextColor="#64748b"/>
                                </VerticalStackLayout>

                                <Frame Grid.Column="1" Padding="8,4" CornerRadius="5" BackgroundColor="#e0e7ff" HasShadow="False" BorderColor="Transparent" VerticalOptions="Start">
                                    <Label Text="{Binding Status}" FontSize="11" TextColor="#2563eb" FontAttributes="Bold"/>
                                </Frame>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- Spinner de Carregamento (Centralizado na área da lista) -->
        <ActivityIndicator Grid.Row="1" IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" Color="#2563eb" VerticalOptions="Center" HorizontalOptions="Center"/>

    </Grid>
</ContentPage>